<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Working Time</title>
  <link rel="manifest" href="./manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    :root {
      --bg: #0a0e1a; --surface: rgba(15, 23, 42, 0.7); --elevated: rgba(30, 41, 59, 0.9);
      --fg: #f1f5f9; --fg-muted: #94a3b8; --primary: #38bdf8; --border: rgba(148, 163, 184, 0.15);
      --accent-gold: #fbbf24; --radius: 16px;
    }
    [data-theme="light"] {
      --bg: #f8fafc; --surface: rgba(255, 255, 255, 0.8); --elevated: #ffffff;
      --fg: #0f172a; --fg-muted: #64748b; --border: rgba(0,0,0,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--fg); padding: 16px; min-height: 100vh; transition: 0.3s; }
    .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

    /* Header & Rank */
    .header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-start; }
    .header h1 { font-size: 1.8rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }
    .rank-badge { background: linear-gradient(90deg, var(--primary), #a78bfa); color: #000; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-top: 5px; display: inline-block; }

    /* Gamification Cards */
    .gamification-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
    .streak-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; text-align: center; }
    .streak-val { font-size: 1.5rem; font-weight: 800; color: var(--accent-gold); display: block; }
    
    /* Progress Bar */
    .goal-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; grid-column: span 2; }
    .progress-container { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; margin-top: 10px; overflow: hidden; }
    .progress-bar { height: 100%; width: 0%; background: var(--primary); transition: 1s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; }
    .stat-label { font-size: 0.7rem; color: var(--fg-muted); text-transform: uppercase; margin-bottom: 5px; }
    .stat-value { font-size: 1.2rem; font-weight: 700; }

    /* Buttons & Inputs */
    .period-btns { display: flex; gap: 8px; margin-bottom: 12px; }
    .btn-period { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--fg-muted); font-weight: 600; cursor: pointer; }
    .btn-period.active { background: var(--primary); color: #000; }
    .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; height: 200px; margin-bottom: 20px; }

    /* Modal Saisie */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .floating-fieldset { background: var(--elevated); width: 100%; max-width: 400px; border-radius: 24px; padding: 24px; border: 1px solid var(--border); }
    .form-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); font-size: 1rem; margin-top: 5px; }
    
    .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: #000; border: none; border-radius: 50%; font-size: 2rem; cursor: pointer; z-index: 99; box-shadow: 0 8px 20px rgba(56,189,248,0.3); }
    
    /* Details Accordion */
    .btn-details { width: 100%; padding: 12px; background: var(--surface); border: 1px solid var(--border); color: var(--fg); border-radius: 12px; cursor: pointer; font-weight: 600; margin-bottom: 10px; }
    #details-list { display: none; margin-bottom: 20px; }
    #details-list.active { display: block; }
    .detail-item { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px; display: grid; grid-template-columns: 1.5fr 1.5fr 1fr; font-size: 0.8rem; }
  </style>
</head>
<body>

<div class="container">
  <header class="header">
    <div>
      <h1>Working Time</h1>
      <div id="user-rank" class="rank-badge">Explorateur du Temps</div>
    </div>
    <div id="themeToggle" style="cursor: pointer; font-size: 1.2rem;">üåô</div>
  </header>

  <div class="gamification-row">
    <div class="streak-card">
      <span class="stat-label">S√©rie de jours</span>
      <span class="streak-val" id="streak-count">0 üî•</span>
    </div>
    <div class="streak-card">
      <span class="stat-label">Productivit√©</span>
      <span class="streak-val" id="prod-score">--</span>
    </div>
    <div class="goal-card">
      <div style="display: flex; justify-content: space-between;">
        <span class="stat-label">Objectif du jour (7h30)</span>
        <span id="goal-percent" style="font-weight: 800; color: var(--primary);">0%</span>
      </div>
      <div class="progress-container">
        <div class="progress-bar" id="goal-bar"></div>
      </div>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><p class="stat-label">Moy. Arriv√©e</p><div class="stat-value" id="stat-avg-in">--</div></div>
    <div class="stat-card"><p class="stat-label">Moy. D√©part</p><div class="stat-value" id="stat-avg-out">--</div></div>
  </div>

  <div class="period-btns">
    <button class="btn-period active" onclick="setPeriod('week')">Semaine</button>
    <button class="btn-period" onclick="setPeriod('month')">Mois</button>
  </div>

  <div class="chart-card"><canvas id="mainChart"></canvas></div>

  <button class="btn-details" onclick="document.getElementById('details-list').classList.toggle('active')">Historique d√©taill√© ‚ñº</button>
  <div id="details-list"></div>
</div>

<button class="fab" onclick="toggleModal(true)">+</button>

<div class="modal-overlay" id="modal">
  <div class="floating-fieldset">
    <h3 style="margin-bottom: 20px;">Saisie du jour</h3>
    <div style="margin-bottom:15px;"><label class="stat-label">Date</label><input type="date" id="input-date" class="form-input" onchange="loadExistingData(this.value)"></div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:15px;">
      <div><label class="stat-label">Arriv√©e</label><input type="time" id="input-in" class="form-input"></div>
      <div><label class="stat-label">D√©part</label><input type="time" id="input-out" class="form-input"></div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:20px;">
      <div><label class="stat-label">Sortie D√©j</label><input type="time" id="input-lout" class="form-input"></div>
      <div><label class="stat-label">Retour D√©j</label><input type="time" id="input-lin" class="form-input"></div>
    </div>
    <div style="display: flex; gap: 10px;">
      <button onclick="handleDelete()" style="background:#ef4444; color:white; border:none; border-radius:10px; padding:12px; cursor:pointer;">üóëÔ∏è</button>
      <button onclick="handleSave()" style="flex:1; background:var(--primary); color:#000; border:none; border-radius:10px; font-weight:800; cursor:pointer;">ENREGISTRER</button>
    </div>
  </div>
</div>

<script type="module">
  import { db } from './firebase-config.js';
  import { collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let planningData = {};
  let chart;
  const DAILY_GOAL_MINS = 450; // 7h30

  onSnapshot(collection(db, "planning"), (snapshot) => {
    planningData = {};
    snapshot.forEach(doc => { planningData[doc.id] = doc.data(); });
    calculateGamification();
    setPeriod('week');
  });

  const toMins = (t) => { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; };
  const fromMins = (m) => `${Math.floor(m / 60)}h${(m % 60).toString().padStart(2, '0')}`;

  function calculateGamification() {
    const dates = Object.keys(planningData).sort().reverse();
    
    // 1. Calcul de la s√©rie (Streak)
    let streak = 0;
    let checkDate = new Date();
    while(planningData[checkDate.toISOString().split('T')[0]]) {
      streak++;
      checkDate.setDate(checkDate.getDate() - 1);
    }
    document.getElementById('streak-count').innerText = `${streak} üî•`;

    // 2. Calcul du Rang
    const totalHours = Object.values(planningData).reduce((acc, d) => acc + computeDayMins(d), 0) / 60;
    let rank = "Explorateur";
    if(totalHours > 50) rank = "Gardien du Temps";
    if(totalHours > 200) rank = "Ma√Ætre Chronos";
    if(totalHours > 500) rank = "L√©gende Temporelle";
    document.getElementById('user-rank').innerText = rank;

    // 3. Barre de progression du jour (ou du dernier jour saisi)
    const todayStr = new Date().toISOString().split('T')[0];
    const todayData = planningData[todayStr] || planningData[dates[0]];
    if(todayData) {
      const worked = computeDayMins(todayData);
      const percent = Math.min(Math.round((worked / DAILY_GOAL_MINS) * 100), 100);
      document.getElementById('goal-bar').style.width = percent + '%';
      document.getElementById('goal-percent').innerText = percent + '%';
      if(percent >= 100) document.getElementById('goal-bar').style.background = '#10b981';
    }
  }

  function computeDayMins(d) {
    let w = toMins(d.out) - toMins(d.in);
    if(d.lunchOut && d.lunchIn) w -= (toMins(d.lunchIn) - toMins(d.lunchOut));
    return Math.max(w, 0);
  }

  window.setPeriod = (type) => {
    const start = new Date();
    if(type === 'week') start.setDate(start.getDate() - 7);
    else start.setMonth(start.getMonth() - 1);
    const startStr = start.toISOString().split('T')[0];
    const endStr = new Date().toISOString().split('T')[0];
    
    const filtered = Object.entries(planningData)
      .filter(([date]) => date >= startStr && date <= endStr)
      .sort((a,b) => a[0].localeCompare(b[0]));
    
    updateStats(filtered);
    updateChart(filtered);
    updateHistory(filtered);
    document.querySelectorAll('.btn-period').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(type)));
  };

  function updateStats(entries) {
    if(!entries.length) return;
    let sumIn = 0, sumOut = 0, totalWork = 0;
    entries.forEach(([_, d]) => {
      sumIn += toMins(d.in); sumOut += toMins(d.out);
      totalWork += computeDayMins(d);
    });
    document.getElementById('stat-avg-in').innerText = fromMins(Math.round(sumIn / entries.length)).replace('h', ':');
    document.getElementById('stat-avg-out').innerText = fromMins(Math.round(sumOut / entries.length)).replace('h', ':');
    document.getElementById('prod-score').innerText = Math.round((totalWork / (entries.length * DAILY_GOAL_MINS)) * 100) + '%';
  }

  function updateHistory(entries) {
    const list = document.getElementById('details-list');
    list.innerHTML = entries.reverse().map(([date, d]) => `
      <div class="detail-item">
        <div>${date.split('-').reverse().slice(0,2).join('/')}</div>
        <div style="color:var(--fg-muted)">${d.in} > ${d.out}</div>
        <div style="font-weight:bold; color:var(--primary)">${fromMins(computeDayMins(d))}</div>
      </div>
    `).join('');
  }

  function updateChart(entries) {
    const ctx = document.getElementById('mainChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: { 
        labels: entries.map(e => e[0].split('-').reverse().slice(0,2).join('/')), 
        datasets: [{ data: entries.map(e => (computeDayMins(e[1])/60).toFixed(2)), borderColor: '#38bdf8', tension: 0.4, fill: true, backgroundColor: 'rgba(56,189,248,0.1)' }] 
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  }

  window.toggleModal = (s) => document.getElementById('modal').classList.toggle('active', s);
  window.handleSave = async () => {
    const d = document.getElementById('input-date').value;
    const data = { in: document.getElementById('input-in').value, out: document.getElementById('input-out').value, lunchOut: document.getElementById('input-lout').value, lunchIn: document.getElementById('input-lin').value };
    await setDoc(doc(db, "planning", d), data);
    if(computeDayMins(data) >= DAILY_GOAL_MINS) confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
    toggleModal(false);
  };
  window.handleDelete = async () => {
    const d = document.getElementById('input-date').value;
    if(confirm("Supprimer ?")) { await deleteDoc(doc(db, "planning", d)); toggleModal(false); }
  };
  window.loadExistingData = (date) => {
    const d = planningData[date] || { in: '', out: '', lunchOut: '', lunchIn: '' };
    document.getElementById('input-in').value = d.in; document.getElementById('input-out').value = d.out;
    document.getElementById('input-lout').value = d.lunchOut; document.getElementById('input-lin').value = d.lunchIn;
  };
</script>
</body>
</html>
