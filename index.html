<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Working Time</title>
  <link rel="manifest" href="./manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    
    :root {
      --bg: #0a0e1a; --surface: rgba(15, 23, 42, 0.7); --elevated: rgba(30, 41, 59, 0.9);
      --fg: #f1f5f9; --fg-muted: #94a3b8; --primary: #38bdf8; --border: rgba(148, 163, 184, 0.15);
      --accent-fire: #fb923c; --radius: 16px;
    }

    /* FIX MODE CLAIR */
    [data-theme="light"] {
      --bg: #f1f5f9; --surface: rgba(255, 255, 255, 0.8); --elevated: #ffffff;
      --fg: #0f172a; --fg-muted: #64748b; --border: rgba(0, 0, 0, 0.1);
      --primary: #0284c7;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--fg); padding: 16px; min-height: 100vh; transition: 0.3s; }
    .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

    /* Header */
    .header { margin-bottom: 20px; }
    .header-top { display: flex; justify-content: space-between; align-items: center; }
    h1 { font-size: 1.8rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
    .rank-badge { background: var(--primary); color: #fff; padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-top: 4px; display: inline-block; }

    /* Gamification (Focus R√©gularit√©) */
    .game-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .game-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; text-align: center; backdrop-filter: blur(10px); }
    .streak-val { font-size: 1.6rem; font-weight: 800; color: var(--accent-fire); display: block; }
    .game-label { font-size: 0.65rem; color: var(--fg-muted); text-transform: uppercase; font-weight: 700; }

    /* STATISTIQUE MAITRESSE */
    .main-stat-card { background: var(--surface); border: 2px solid var(--primary); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; text-align: center; }
    .main-stat-val { font-size: 2.5rem; font-weight: 800; color: var(--fg); display: block; margin: 5px 0; }

    /* Filtres & Dates */
    .filter-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; margin-bottom: 20px; }
    .period-btns { display: flex; gap: 8px; margin-bottom: 12px; }
    .btn-period { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg-muted); font-weight: 600; cursor: pointer; }
    .btn-period.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .date-range { display: flex; gap: 8px; align-items: center; }
    .date-range input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--fg); padding: 8px; border-radius: 8px; font-size: 0.8rem; }

    /* Graph */
    .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; height: 220px; margin-bottom: 20px; }

    /* FAB & Modal */
    .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: #fff; border: none; border-radius: 50%; font-size: 2rem; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.3); z-index: 99; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: var(--elevated); width: 100%; max-width: 400px; border-radius: 24px; padding: 24px; }
    .modal-content input { width: 100%; padding: 12px; margin-top: 5px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); font-size: 1rem; }
    
    /* Historique */
    .details-btn { width: 100%; padding: 12px; background: var(--surface); border: 1px solid var(--border); color: var(--fg); border-radius: 12px; cursor: pointer; font-weight: 600; margin-bottom: 10px; }
    #details-list { display: none; background: var(--surface); border-radius: 12px; overflow: hidden; margin-bottom: 20px; }
    #details-list.active { display: block; }
    .detail-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
  </style>
</head>
<body>

<div class="container">
  <header class="header">
    <div class="header-top">
      <div>
        <h1>Working Time</h1>
        <div id="user-rank" class="rank-badge">Apprenti de l'√âquilibre</div>
      </div>
      <div id="themeToggle" style="cursor: pointer; font-size: 1.4rem;">üåô</div>
    </div>
    <p style="color: var(--fg-muted); font-size: 0.85rem; font-style: italic;">Mesurer le temps pour mieux le g√©rer</p>
  </header>

  <div class="game-row">
    <div class="game-card">
      <span class="game-label">Assiduit√©</span>
      <span class="streak-val" id="streak-count">0 üî•</span>
    </div>
    <div class="game-card">
      <span class="game-label">Saisie Totale</span>
      <span class="streak-val" id="total-entries">0 üìñ</span>
    </div>
  </div>

  <div class="main-stat-card">
    <span class="game-label">Moyenne travaill√©e / jour</span>
    <span class="main-stat-val" id="stat-avg-work">0h00</span>
    <span id="stat-total-period" style="font-size: 0.8rem; color: var(--fg-muted);">Total p√©riode : 0h</span>
  </div>

  <div class="filter-box">
    <div class="period-btns">
      <button class="btn-period" onclick="setPeriod('week')">Semaine</button>
      <button class="btn-period active" onclick="setPeriod('month')">Mois</button>
    </div>
    <div class="date-range">
      <input type="date" id="filter-start" onchange="manualFilter()">
      <span style="color: var(--fg-muted)">‚Üí</span>
      <input type="date" id="filter-end" onchange="manualFilter()">
    </div>
  </div>

  <div class="chart-card"><canvas id="mainChart"></canvas></div>

  <button class="details-btn" onclick="document.getElementById('details-list').classList.toggle('active')">Voir les d√©tails de la p√©riode ‚ñº</button>
  <div id="details-list"></div>
</div>

<button class="fab" onclick="toggleModal(true)">+</button>

<div class="modal" id="modal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
      <h3>Saisie du jour</h3>
      <button onclick="toggleModal(false)" style="background:none; border:none; color:var(--fg-muted); font-size:1.5rem; cursor:pointer;">&times;</button>
    </div>
    <div style="margin-bottom:10px;"><label class="game-label">Date</label><input type="date" id="in-date" onchange="loadData(this.value)"></div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
      <div><label class="game-label">Arriv√©e</label><input type="time" id="in-time"></div>
      <div><label class="game-label">D√©part</label><input type="time" id="out-time"></div>
    </div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
      <div><label class="game-label">D√©but D√©j</label><input type="time" id="in-l-out"></div>
      <div><label class="game-label">Fin D√©j</label><input type="time" id="in-l-in"></div>
    </div>
    <div style="display:flex; gap:10px;">
      <button onclick="handleDelete()" style="background:#ef4444; color:white; border:none; border-radius:10px; padding:12px; cursor:pointer;">üóëÔ∏è</button>
      <button onclick="handleSave()" style="flex:1; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:800; cursor:pointer;">ENREGISTRER</button>
    </div>
  </div>
</div>

<script type="module">
  import { db } from './firebase-config.js';
  import { collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let planningData = {};
  let chart;

  // Sync Firestore
  onSnapshot(collection(db, "planning"), (snapshot) => {
    planningData = {};
    snapshot.forEach(doc => { planningData[doc.id] = doc.data(); });
    calculateRegularity();
    manualFilter();
  });

  const toMins = (t) => { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; };
  const fromMins = (m) => `${Math.floor(m / 60)}h${(m % 60).toString().padStart(2, '0')}`;

  // GAMIFICATION : FOCUS SUR LA R√âGULARIT√â
  function calculateRegularity() {
    const dates = Object.keys(planningData).sort().reverse();
    
    // Streak (jours cons√©cutifs de saisie)
    let streak = 0;
    let check = new Date();
    while(planningData[check.toISOString().split('T')[0]]) {
      streak++;
      check.setDate(check.getDate() - 1);
    }
    document.getElementById('streak-count').innerText = `${streak} üî•`;
    document.getElementById('total-entries').innerText = `${dates.length} üìñ`;

    // Rangs bas√©s sur la sagesse (nombre de saisies)
    let rank = "Apprenti de l'√âquilibre";
    if(dates.length > 10) rank = "Organisateur Serein";
    if(dates.length > 30) rank = "Ma√Ætre du Temps";
    if(dates.length > 100) rank = "Sage de la Mesure";
    document.getElementById('user-rank').innerText = rank;
  }

  window.manualFilter = () => {
    const start = document.getElementById('filter-start').value;
    const end = document.getElementById('filter-end').value;
    const filtered = Object.entries(planningData)
      .filter(([date]) => date >= start && date <= end)
      .sort((a,b) => a[0].localeCompare(b[0]));
    
    updateDisplay(filtered);
  };

  window.setPeriod = (type) => {
    const end = new Date();
    const start = new Date();
    if(type === 'week') start.setDate(end.getDate() - 7);
    else start.setMonth(end.getMonth() - 1);
    
    document.getElementById('filter-start').value = start.toISOString().split('T')[0];
    document.getElementById('filter-end').value = end.toISOString().split('T')[0];
    document.querySelectorAll('.btn-period').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(type)));
    manualFilter();
  };

  function updateDisplay(entries) {
    if(!entries.length) {
      document.getElementById('stat-avg-work').innerText = "0h00";
      return;
    }

    let totalMins = 0;
    entries.forEach(([_, d]) => {
      let daily = toMins(d.out) - toMins(d.in);
      if(d.lunchOut && d.lunchIn) daily -= (toMins(d.lunchIn) - toMins(d.lunchOut));
      totalMins += Math.max(daily, 0);
    });

    document.getElementById('stat-avg-work').innerText = fromMins(Math.round(totalMins / entries.length));
    document.getElementById('stat-total-period').innerText = `Total p√©riode : ${fromMins(totalMins)}`;

    // Update Chart
    const ctx = document.getElementById('mainChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: entries.map(e => e[0].split('-').reverse().slice(0,2).join('/')),
        datasets: [{ data: entries.map(e => {
          let d = e[1];
          let w = toMins(d.out) - toMins(d.in);
          if(d.lunchOut && d.lunchIn) w -= (toMins(d.lunchIn) - toMins(d.lunchOut));
          return (w/60).toFixed(2);
        }), borderColor: '#38bdf8', tension: 0.4, fill: true, backgroundColor: 'rgba(56,189,248,0.1)' }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    // Update History
    document.getElementById('details-list').innerHTML = entries.reverse().map(([date, d]) => {
      let w = toMins(d.out) - toMins(d.in);
      if(d.lunchOut && d.lunchIn) w -= (toMins(d.lunchIn) - toMins(d.lunchOut));
      return `<div class="detail-row">
        <div>${date.split('-').reverse().join('/')}</div>
        <div style="color:var(--fg-muted)">${d.in}-${d.out}</div>
        <div style="font-weight:bold">${fromMins(w)}</div>
      </div>`;
    }).join('');
  }

  // UI ACTIONS
  window.toggleModal = (s) => {
    document.getElementById('modal').classList.toggle('active', s);
    if(s) {
      const d = new Date().toISOString().split('T')[0];
      document.getElementById('in-date').value = d;
      loadData(d);
    }
  };

  window.loadData = (date) => {
    const d = planningData[date] || { in:'', out:'', lunchOut:'', lunchIn:'' };
    document.getElementById('in-time').value = d.in || '';
    document.getElementById('out-time').value = d.out || '';
    document.getElementById('in-l-out').value = d.lunchOut || '';
    document.getElementById('in-l-in').value = d.lunchIn || '';
  };

  window.handleSave = async () => {
    const date = document.getElementById('in-date').value;
    const data = {
      in: document.getElementById('in-time').value,
      out: document.getElementById('out-time').value,
      lunchOut: document.getElementById('in-l-out').value,
      lunchIn: document.getElementById('in-l-in').value
    };
    await setDoc(doc(db, "planning", date), data);
    confetti({ particleCount: 80, spread: 50, origin: { y: 0.8 } });
    toggleModal(false);
  };

  window.handleDelete = async () => {
    const date = document.getElementById('in-date').value;
    if(confirm("Supprimer ?")) { await deleteDoc(doc(db, "planning", date)); toggleModal(false); }
  };

  // Theme Toggle
  document.getElementById('themeToggle').onclick = () => {
    const current = document.documentElement.getAttribute('data-theme');
    const target = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', target);
    document.getElementById('themeToggle').innerText = target === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  };

  setPeriod('month');
</script>
</body>
</html>
