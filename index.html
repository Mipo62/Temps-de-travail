<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WorkTime Pro</title>
  <link rel="manifest" href="./manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    :root {
      --bg: #0a0e1a; --surface: rgba(15, 23, 42, 0.7); --elevated: rgba(30, 41, 59, 0.9);
      --fg: #f1f5f9; --fg-muted: #94a3b8; --primary: #38bdf8; --border: rgba(148, 163, 184, 0.15);
      --radius: 16px;
    }
    [data-theme="light"] {
      --bg: #f8fafc; --surface: rgba(255, 255, 255, 0.8); --elevated: #ffffff;
      --fg: #0f172a; --fg-muted: #64748b; --border: rgba(0,0,0,0.1);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--fg); padding: 16px; min-height: 100vh; transition: 0.3s; }
    .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header h1 { font-size: 1.5rem; font-weight: 800; color: var(--primary); }

    /* Vue d'ensemble */
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
    .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; backdrop-filter: blur(10px); }
    .stat-label { font-size: 0.7rem; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 5px; }
    .stat-value { font-size: 1.2rem; font-weight: 700; color: var(--fg); }

    /* Filtres */
    .filter-section { margin-bottom: 20px; }
    .period-btns { display: flex; gap: 8px; margin-bottom: 12px; }
    .btn-period { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--surface); color: var(--fg-muted); font-weight: 600; cursor: pointer; }
    .btn-period.active { background: var(--primary); color: #000; border-color: var(--primary); }
    .range-inputs { display: flex; gap: 10px; align-items: center; background: var(--surface); padding: 10px; border-radius: 12px; }
    .range-inputs input { background: transparent; border: none; color: var(--fg); font-size: 0.85rem; width: 100%; outline: none; }

    /* Graphique */
    .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; height: 220px; margin-bottom: 20px; }

    /* Bouton Flottant Saisie */
    .fab { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: #000; border: none; border-radius: 50%; font-size: 2rem; cursor: pointer; box-shadow: 0 10px 25px rgba(56, 189, 248, 0.4); display: flex; align-items: center; justify-content: center; z-index: 99; }

    /* Fieldset Flottant (Modal) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .floating-fieldset { background: var(--elevated); width: 100%; max-width: 400px; border-radius: 24px; padding: 24px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 0.8rem; color: var(--fg-muted); margin-bottom: 6px; }
    .form-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); font-size: 1rem; }
    .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
    .btn-save { flex: 2; background: var(--primary); color: #000; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
    .btn-delete { flex: 1; background: #ef4444; color: #fff; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
  </style>
</head>
<body>

<div class="container">
  <header class="header">
    <h1>WorkTime</h1>
    <div id="themeToggle" style="cursor: pointer; font-size: 1.2rem;">üåô</div>
  </header>

  <div class="stats-grid">
    <div class="stat-card">
      <p class="stat-label">Moy. Travail</p>
      <div class="stat-value" id="stat-avg-work">--</div>
    </div>
    <div class="stat-card">
      <p class="stat-label">Nb Jours</p>
      <div class="stat-value" id="stat-count">0</div>
    </div>
    <div class="stat-card">
      <p class="stat-label">Arriv√©e Moy.</p>
      <div class="stat-value" id="stat-avg-in">--</div>
    </div>
    <div class="stat-card">
      <p class="stat-label">D√©part Moy.</p>
      <div class="stat-value" id="stat-avg-out">--</div>
    </div>
    <div class="stat-card" style="grid-column: span 2;">
      <p class="stat-label">Pause D√©j Moyenne</p>
      <div class="stat-value" id="stat-avg-lunch">--</div>
    </div>
  </div>

  <div class="filter-section">
    <div class="period-btns">
      <button class="btn-period" onclick="setPeriod('week')">Semaine</button>
      <button class="btn-period active" onclick="setPeriod('month')">Mois</button>
    </div>
    <div class="range-inputs">
      <input type="date" id="filter-start" onchange="manualFilter()">
      <span style="color: var(--fg-muted)">‚Üí</span>
      <input type="date" id="filter-end" onchange="manualFilter()">
    </div>
  </div>

  <div class="chart-card">
    <canvas id="mainChart"></canvas>
  </div>
</div>

<button class="fab" onclick="toggleModal(true)">+</button>

<div class="modal-overlay" id="modal">
  <div class="floating-fieldset">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3 style="font-weight: 700;">Nouvelle Saisie</h3>
      <button onclick="toggleModal(false)" style="background:none; border:none; color:var(--fg-muted); font-size:1.5rem; cursor:pointer;">&times;</button>
    </div>
    
    <div class="form-group">
      <label>Date</label>
      <input type="date" id="input-date" class="form-input" onchange="loadExistingData(this.value)">
    </div>
    <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <div><label>Arriv√©e</label><input type="time" id="input-in" class="form-input"></div>
      <div><label>D√©part</label><input type="time" id="input-out" class="form-input"></div>
    </div>
    <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <div><label>Sortie D√©j</label><input type="time" id="input-lout" class="form-input"></div>
      <div><label>Retour D√©j</label><input type="time" id="input-lin" class="form-input"></div>
    </div>

    <div class="modal-btns">
      <button class="btn-delete" id="btn-del" onclick="handleDelete()">üóëÔ∏è</button>
      <button class="btn-save" onclick="handleSave()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<script type="module">
  import { db } from './firebase-config.js';
  import { collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let planningData = {};
  let chart;

  // Initialisation Firestore
  onSnapshot(collection(db, "planning"), (snapshot) => {
    planningData = {};
    snapshot.forEach(doc => { planningData[doc.id] = doc.data(); });
    manualFilter(); // Met √† jour l'affichage selon le filtre actuel
  });

  // --- LOGIQUE FILTRAGE ---
  function manualFilter() {
    const start = document.getElementById('filter-start').value;
    const end = document.getElementById('filter-end').value;
    if(!start || !end) return;

    const filtered = Object.entries(planningData)
      .filter(([date]) => date >= start && date <= end)
      .sort((a,b) => a[0].localeCompare(b[0]));

    updateStats(filtered);
    updateChart(filtered);
  }
  window.manualFilter = manualFilter;

  function setPeriod(type) {
    const today = new Date();
    let start = new Date();
    if (type === 'week') start.setDate(today.getDate() - 7);
    if (type === 'month') start.setMonth(today.getMonth() - 1);
    
    document.getElementById('filter-start').value = start.toISOString().split('T')[0];
    document.getElementById('filter-end').value = today.toISOString().split('T')[0];
    
    document.querySelectorAll('.btn-period').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(type)));
    manualFilter();
  }
  window.setPeriod = setPeriod;

  // --- CALCULS STATS ---
  const toMins = (t) => { if(!t) return null; const [h, m] = t.split(':').map(Number); return h * 60 + m; };
  const fromMins = (m) => `${Math.floor(m / 60)}h${(m % 60).toString().padStart(2, '0')}`;
  const fromMinsToTime = (m) => `${Math.floor(m / 60).toString().padStart(2, '0')}:${(m % 60).toString().padStart(2, '0')}`;

  function updateStats(entries) {
    if(!entries.length) {
      document.querySelectorAll('.stat-value').forEach(el => el.innerText = '--');
      document.getElementById('stat-count').innerText = '0';
      return;
    }

    let totalWork = 0, sumIn = 0, sumOut = 0, sumLunch = 0;
    let countIn = 0, countOut = 0, countL = 0;

    entries.forEach(([_, d]) => {
      const minsIn = toMins(d.in), minsOut = toMins(d.out), lOut = toMins(d.lunchOut), lIn = toMins(d.lunchIn);
      if(minsIn && minsOut) {
        let work = minsOut - minsIn;
        if(lOut && lIn) { work -= (lIn - lOut); sumLunch += (lIn - lOut); countL++; }
        totalWork += work;
        sumIn += minsIn; countIn++;
        sumOut += minsOut; countOut++;
      }
    });

    document.getElementById('stat-avg-work').innerText = fromMins(Math.round(totalWork / entries.length));
    document.getElementById('stat-count').innerText = entries.length;
    document.getElementById('stat-avg-in').innerText = countIn ? fromMinsToTime(Math.round(sumIn / countIn)) : '--';
    document.getElementById('stat-avg-out').innerText = countOut ? fromMinsToTime(Math.round(sumOut / countOut)) : '--';
    document.getElementById('stat-avg-lunch').innerText = countL ? fromMins(Math.round(sumLunch / countL)) : '--';
  }

  // --- GRAPH ---
  function updateChart(entries) {
    const ctx = document.getElementById('mainChart').getContext('2d');
    const labels = entries.map(e => e[0].slice(5));
    const data = entries.map(([_, d]) => {
      let work = toMins(d.out) - toMins(d.in);
      if(d.lunchOut && d.lunchIn) work -= (toMins(d.lunchIn) - toMins(d.lunchOut));
      return (work / 60).toFixed(2);
    });

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ data, borderColor: '#38bdf8', tension: 0.4, fill: true, backgroundColor: 'rgba(56,189,248,0.1)' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
  }

  // --- ACTIONS MODAL ---
  window.toggleModal = (show) => {
    document.getElementById('modal').classList.toggle('active', show);
    if(show) {
      document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
      loadExistingData(document.getElementById('input-date').value);
    }
  };

  window.loadExistingData = (date) => {
    const d = planningData[date] || { in: '', out: '', lunchOut: '', lunchIn: '' };
    document.getElementById('input-in').value = d.in;
    document.getElementById('input-out').value = d.out;
    document.getElementById('input-lout').value = d.lunchOut;
    document.getElementById('input-lin').value = d.lunchIn;
  };

  window.handleSave = async () => {
    const date = document.getElementById('input-date').value;
    const data = {
      in: document.getElementById('input-in').value,
      out: document.getElementById('input-out').value,
      lunchOut: document.getElementById('input-lout').value,
      lunchIn: document.getElementById('input-lin').value
    };
    if(!date || !data.in) return alert("Date et Heure d'entr√©e requises");
    await setDoc(doc(db, "planning", date), data);
    toggleModal(false);
  };

  window.handleDelete = async () => {
    const date = document.getElementById('input-date').value;
    if(date && confirm("Supprimer cette journ√©e ?")) {
      await deleteDoc(doc(db, "planning", date));
      toggleModal(false);
    }
  };

  // Theme
  document.getElementById('themeToggle').onclick = () => {
    const t = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', t);
    document.getElementById('themeToggle').innerText = t === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  };

  // Init par d√©faut sur le mois
  setPeriod('month');
</script>
</body>
</html>
