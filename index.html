<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Working Time</title>
  <link rel="manifest" href="./manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    
    :root {
      --bg: #0a0e1a; --surface: rgba(15, 23, 42, 0.7); --elevated: rgba(30, 41, 59, 0.9);
      --fg: #f1f5f9; --fg-muted: #94a3b8; --primary: #38bdf8; --border: rgba(148, 163, 184, 0.15);
      --accent-fire: #fb923c; --radius: 16px;
    }

    /* Correction Mode Clair */
    [data-theme="light"] {
      --bg: #f1f5f9; --surface: rgba(255, 255, 255, 0.85); --elevated: #ffffff;
      --fg: #0f172a; --fg-muted: #64748b; --border: rgba(0, 0, 0, 0.1);
      --primary: #0284c7;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--fg); padding: 16px; min-height: 100vh; transition: 0.3s; }
    .container { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

    /* Header & Rangs */
    .header { margin-bottom: 20px; }
    .header-top { display: flex; justify-content: space-between; align-items: center; }
    h1 { font-size: 1.8rem; font-weight: 800; color: var(--primary); letter-spacing: -1px; }
    .rank-badge { background: var(--primary); color: #fff; padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; margin-top: 4px; display: inline-block; }
    .subtitle { color: var(--fg-muted); font-size: 0.85rem; font-style: italic; margin-top: 5px; }

    /* Gamification Row */
    .game-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .game-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; text-align: center; backdrop-filter: blur(10px); }
    .streak-val { font-size: 1.6rem; font-weight: 800; color: var(--accent-fire); display: block; }
    .game-label { font-size: 0.65rem; color: var(--fg-muted); text-transform: uppercase; font-weight: 700; }

    /* Moyenne Centrale */
    .main-stat-card { background: var(--surface); border: 2px solid var(--primary); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; text-align: center; }
    .main-stat-val { font-size: 2.5rem; font-weight: 800; color: var(--fg); display: block; margin: 5px 0; }

    /* Filtres */
    .filter-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; margin-bottom: 15px; }
    .period-btns { display: flex; gap: 8px; margin-bottom: 12px; }
    .btn-period { flex: 1; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg-muted); font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-period.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .date-range { display: flex; gap: 8px; align-items: center; }
    .date-range input { flex: 1; background: var(--bg); border: 1px solid var(--border); color: var(--fg); padding: 8px; border-radius: 8px; font-size: 0.8rem; outline: none; }

    /* Graphique */
    .chart-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 15px; height: 220px; margin-bottom: 20px; }

    /* FAB & Modal */
    .fab { position: fixed; bottom: 20px; right: 20px; width: 64px; height: 64px; background: var(--primary); color: #fff; border: none; border-radius: 50%; font-size: 2rem; cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 99; transition: 0.2s; }
    .fab:active { transform: scale(0.9); }
    
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal.active { display: flex; }
    .modal-content { background: var(--elevated); width: 100%; max-width: 400px; border-radius: 24px; padding: 24px; border: 1px solid var(--border); }
    .modal-content label { display: block; margin-top: 10px; }
    .modal-content input { width: 100%; padding: 12px; margin-top: 5px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg); color: var(--fg); font-size: 1rem; }
    
    /* Historique */
    .details-btn { width: 100%; padding: 12px; background: var(--surface); border: 1px solid var(--border); color: var(--fg); border-radius: 12px; cursor: pointer; font-weight: 600; margin-bottom: 10px; display: flex; justify-content: space-between; }
    #details-list { display: none; background: var(--surface); border-radius: 12px; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border); }
    #details-list.active { display: block; }
    .detail-row { display: grid; grid-template-columns: 1fr 1fr 1fr; padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
  </style>
</head>
<body>

<div class="container">
  <header class="header">
    <div class="header-top">
      <div>
        <h1>Working Time</h1>
        <div id="user-rank" class="rank-badge">Apprenti de l'√âquilibre</div>
      </div>
      <div id="themeToggle" style="cursor: pointer; font-size: 1.4rem;">üåô</div>
    </div>
    <p class="subtitle">Mesurer le temps pour mieux le g√©rer</p>
  </header>

  <div class="game-row">
    <div class="game-card">
      <span class="game-label">Assiduit√©</span>
      <span class="streak-val" id="streak-count">0 üî•</span>
    </div>
    <div class="game-card">
      <span class="game-label">Saisies</span>
      <span class="streak-val" id="total-entries">0 üìñ</span>
    </div>
  </div>

  <div class="main-stat-card">
    <span class="game-label">Moyenne quotidienne travaill√©e</span>
    <span class="main-stat-val" id="stat-avg-work">0h00</span>
    <span id="stat-total-period" style="font-size: 0.8rem; color: var(--fg-muted);">Sur la p√©riode s√©lectionn√©e</span>
  </div>

  <div class="filter-box">
    <div class="period-btns">
      <button class="btn-period" onclick="setPeriod('week')">Semaine</button>
      <button class="btn-period active" onclick="setPeriod('month')">Mois</button>
    </div>
    <div class="date-range">
      <input type="date" id="filter-start" onchange="manualFilter()">
      <span style="color: var(--fg-muted)">‚Üí</span>
      <input type="date" id="filter-end" onchange="manualFilter()">
    </div>
  </div>

  <div class="chart-card"><canvas id="mainChart"></canvas></div>

  <button class="details-btn" onclick="document.getElementById('details-list').classList.toggle('active')">
    Historique d√©taill√© de la p√©riode <span>‚ñº</span>
  </button>
  <div id="details-list"></div>
</div>

<button class="fab" onclick="toggleModal(true)">+</button>

<div class="modal" id="modal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 style="font-weight: 800;">Saisie du jour</h3>
      <button onclick="toggleModal(false)" style="background:none; border:none; color:var(--fg-muted); font-size:1.8rem; cursor:pointer;">&times;</button>
    </div>
    <label class="game-label">Date</label>
    <input type="date" id="in-date" onchange="loadExistingData(this.value)">
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      <div><label class="game-label">Arriv√©e</label><input type="time" id="in-time"></div>
      <div><label class="game-label">D√©part</label><input type="time" id="out-time"></div>
    </div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
      <div><label class="game-label">Pause (D√©but)</label><input type="time" id="l-out"></div>
      <div><label class="game-label">Pause (Fin)</label><input type="time" id="l-in"></div>
    </div>

    <div style="display:flex; gap:10px;">
      <button onclick="handleDelete()" style="background:#ef4444; color:white; border:none; border-radius:12px; padding:14px; cursor:pointer; flex: 1;">üóëÔ∏è</button>
      <button onclick="handleSave()" style="flex:3; background:var(--primary); color:white; border:none; border-radius:12px; font-weight:800; cursor:pointer;">ENREGISTRER</button>
    </div>
  </div>
</div>

<script type="module">
  import { db } from './firebase-config.js';
  import { collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let planningData = {};
  let chart;

  // Sync Temps R√©el
  onSnapshot(collection(db, "planning"), (snapshot) => {
    planningData = {};
    snapshot.forEach(doc => { planningData[doc.id] = doc.data(); });
    calculateGamification();
    manualFilter();
  });

  const toMins = (t) => { if(!t) return 0; const [h, m] = t.split(':').map(Number); return h * 60 + m; };
  const fromMins = (m) => `${Math.floor(m / 60)}h${(m % 60).toString().padStart(2, '0')}`;

  // GAMIFICATION (Ignorer week-ends pour la s√©rie)
  function calculateGamification() {
    const dates = Object.keys(planningData).sort().reverse();
    let streak = 0;
    let checkDate = new Date();

    while(true) {
      let dayStr = checkDate.toISOString().split('T')[0];
      let dayOfWeek = checkDate.getDay(); // 0=Dimanche, 6=Samedi

      if (planningData[dayStr]) {
        streak++;
      } else if (dayOfWeek === 0 || dayOfWeek === 6) {
        // C'est le week-end vide, on continue sans briser la s√©rie
      } else {
        // Jour de semaine vide : s√©rie bris√©e (sauf si c'est aujourd'hui)
        if (dayStr !== new Date().toISOString().split('T')[0]) break;
      }
      checkDate.setDate(checkDate.getDate() - 1);
      if (streak > 5000) break; 
    }

    document.getElementById('streak-count').innerText = `${streak} üî•`;
    document.getElementById('total-entries').innerText = `${dates.length} üìñ`;

    let rank = "Apprenti de l'√âquilibre";
    if(dates.length > 15) rank = "Organisateur Serein";
    if(dates.length > 50) rank = "Ma√Ætre du Temps";
    if(dates.length > 150) rank = "Sage de la Mesure";
    document.getElementById('user-rank').innerText = rank;
  }

  // FILTRAGE
  window.manualFilter = () => {
    const start = document.getElementById('filter-start').value;
    const end = document.getElementById('filter-end').value;
    const filtered = Object.entries(planningData)
      .filter(([date]) => date >= start && date <= end)
      .sort((a,b) => a[0].localeCompare(b[0]));
    updateView(filtered);
  };

  window.setPeriod = (type) => {
    const end = new Date();
    const start = new Date();
    if(type === 'week') start.setDate(end.getDate() - 7);
    else start.setMonth(end.getMonth() - 1);
    
    document.getElementById('filter-start').value = start.toISOString().split('T')[0];
    document.getElementById('filter-end').value = end.toISOString().split('T')[0];
    document.querySelectorAll('.btn-period').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(type)));
    manualFilter();
  };

  function updateView(entries) {
    let totalMins = 0;
    const historyList = document.getElementById('details-list');
    
    const chartData = entries.map(([date, d]) => {
      let w = toMins(d.out) - toMins(d.in);
      if(d.lunchOut && d.lunchIn) w -= (toMins(d.lunchIn) - toMins(d.lunchOut));
      let finalW = Math.max(w, 0);
      totalMins += finalW;
      return (finalW / 60).toFixed(2);
    });

    // Stats
    document.getElementById('stat-avg-work').innerText = entries.length ? fromMins(Math.round(totalMins / entries.length)) : "0h00";
    document.getElementById('stat-total-period').innerText = `Total : ${fromMins(totalMins)} sur la p√©riode`;

    // Chart
    const ctx = document.getElementById('mainChart').getContext('2d');
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: entries.map(e => e[0].split('-').reverse().slice(0,2).join('/')),
        datasets: [{ data: chartData, borderColor: '#38bdf8', tension: 0.4, fill: true, backgroundColor: 'rgba(56,189,248,0.1)' }]
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    // History
    historyList.innerHTML = [...entries].reverse().map(([date, d]) => {
      let w = toMins(d.out) - toMins(d.in);
      if(d.lunchOut && d.lunchIn) w -= (toMins(d.lunchIn) - toMins(d.lunchOut));
      return `<div class="detail-row">
        <div>${date.split('-').reverse().join('/')}</div>
        <div style="color:var(--fg-muted)">${d.in || '--'} > ${d.out || '--'}</div>
        <div style="font-weight:bold">${fromMins(Math.max(w,0))}</div>
      </div>`;
    }).join('');
  }

  // MODAL ACTIONS
  window.toggleModal = (s) => {
    document.getElementById('modal').classList.toggle('active', s);
    if(s) {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('in-date').value = today;
      loadExistingData(today);
    }
  };

  window.loadExistingData = (date) => {
    const d = planningData[date] || { in:'', out:'', lunchOut:'', lunchIn:'' };
    document.getElementById('in-time').value = d.in || '';
    document.getElementById('out-time').value = d.out || '';
    document.getElementById('l-out').value = d.lunchOut || '';
    document.getElementById('l-in').value = d.lunchIn || '';
  };

  window.handleSave = async () => {
    const date = document.getElementById('in-date').value;
    const data = {
      in: document.getElementById('in-time').value,
      out: document.getElementById('out-time').value,
      lunchOut: document.getElementById('l-out').value,
      lunchIn: document.getElementById('l-in').value
    };
    await setDoc(doc(db, "planning", date), data);
    confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
    toggleModal(false);
  };

  window.handleDelete = async () => {
    const date = document.getElementById('in-date').value;
    if(confirm("Supprimer cette journ√©e ?")) {
      await deleteDoc(doc(db, "planning", date));
      toggleModal(false);
    }
  };

  // Theme Switch
  document.getElementById('themeToggle').onclick = () => {
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('themeToggle').innerText = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
  };

  // Init
  setPeriod('month');
</script>
</body>
</html>
